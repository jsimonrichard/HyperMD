{"version":3,"file":"main.mjs","sources":["../lib/main.ts"],"sourcesContent":["import { Decoration, EditorView, WidgetType } from '@codemirror/view';\nimport { foldDecorationExtension, foldableSyntaxFacet } from '@hypermd/core';\nimport { EditorSelection } from '@codemirror/state';\nimport type { EditorState } from '@codemirror/state';\nimport { eventHandlersWithClass, justPluginSpec } from '@hypermd/core';\nimport DOMPurify from 'dompurify';\nimport type { SyntaxNodeRef } from '@lezer/common';\nimport type { DecorationSet } from '@codemirror/view';\n\nclass HTMLWidget extends WidgetType {\n  constructor(public value: string) {\n    super();\n  }\n\n  toDOM() {\n    const el = document.createElement('div');\n    el.className = 'cm-html-widget';\n    const parsed = new DOMParser().parseFromString(\n      DOMPurify.sanitize(this.value),\n      'text/html',\n    );\n\n    const walk = (root: Node) => {\n      for (const node of [...root.childNodes]) {\n        if (node.nodeType === 3) {\n          // this node is a text node\n          if (/^\\s*$/.test(node.nodeValue || '')) {\n            node.remove();\n            continue;\n          }\n\n          node.textContent =\n            node.textContent?.replace(/[\\t\\n\\r ]+/g, ' ').trim() ?? null;\n        } else {\n          walk(node);\n        }\n      }\n    };\n\n    walk(parsed.body);\n\n    el.append(...parsed.body.childNodes);\n    return el;\n  }\n\n  // allows clicks to pass through to the editor\n  ignoreEvent(_event: Event) {\n    return false;\n    // return event.type !== 'mousedown'; // don't preventDefault for mousedown\n  }\n\n  destroy(dom: HTMLElement): void {\n    dom.remove();\n  }\n}\n\nconst htmlBlockTheme = EditorView.theme({\n  '.cm-html-widget': {\n    padding: '0 2px 0 6px;',\n    borderRadius: '0.5rem',\n  },\n});\n\nexport const htmlBlockExtension = [\n  foldableSyntaxFacet.of({\n    nodePath: 'HTMLBlock',\n    onFold: (state: EditorState, node: SyntaxNodeRef) => {\n      return Decoration.replace({\n        widget: new HTMLWidget(state.doc.sliceString(node.from, node.to)),\n        block: true,\n        inclusive: true,\n      }).range(node.from, node.to);\n    },\n  }),\n  htmlBlockTheme,\n  justPluginSpec({\n    eventHandlers: eventHandlersWithClass({\n      mousedown: {\n        'cm-html-widget': (e: MouseEvent, view: EditorView) => {\n          // Change selection when appropriate so that the content can be edited\n          // (selection by mouse would overshoot the widget content range)\n\n          const ranges = view.state.selection.ranges;\n          if (\n            !ranges ||\n            ranges.length === 0 ||\n            ranges[0]?.anchor !== ranges[0]?.head\n          )\n            return;\n\n          const target = e.target as HTMLElement;\n          const pos = view.posAtDOM(target);\n\n          const decorations = view.state.field(\n            foldDecorationExtension,\n          ) as DecorationSet;\n          decorations!.between(pos, pos, (from: number, to: number) => {\n            setTimeout(() => {\n              view.dispatch({\n                selection: EditorSelection.single(to, from),\n              });\n            }, 0);\n            return false;\n          });\n        },\n      },\n    }),\n  }),\n];\n"],"names":[],"mappings":";;;;AASA,MAAM,mBAAmB,WAAW;AAAA,EAClC,YAAmB,OAAe;AAChC,UAAA;AADiB,SAAA,QAAA;AAAA,EAEnB;AAAA,EAEA,QAAQ;AACN,UAAM,KAAK,SAAS,cAAc,KAAK;AACvC,OAAG,YAAY;AACf,UAAM,SAAS,IAAI,UAAA,EAAY;AAAA,MAC7B,UAAU,SAAS,KAAK,KAAK;AAAA,MAC7B;AAAA,IAAA;AAGF,UAAM,OAAO,CAAC,SAAe;;AAC3B,iBAAW,QAAQ,CAAC,GAAG,KAAK,UAAU,GAAG;AACvC,YAAI,KAAK,aAAa,GAAG;AAEvB,cAAI,QAAQ,KAAK,KAAK,aAAa,EAAE,GAAG;AACtC,iBAAK,OAAA;AACL;AAAA,UACF;AAEA,eAAK,gBACH,UAAK,gBAAL,mBAAkB,QAAQ,eAAe,KAAK,WAAU;AAAA,QAC5D,OAAO;AACL,eAAK,IAAI;AAAA,QACX;AAAA,MACF;AAAA,IACF;AAEA,SAAK,OAAO,IAAI;AAEhB,OAAG,OAAO,GAAG,OAAO,KAAK,UAAU;AACnC,WAAO;AAAA,EACT;AAAA;AAAA,EAGA,YAAY,QAAe;AACzB,WAAO;AAAA,EAET;AAAA,EAEA,QAAQ,KAAwB;AAC9B,QAAI,OAAA;AAAA,EACN;AACF;AAEA,MAAM,iBAAiB,WAAW,MAAM;AAAA,EACtC,mBAAmB;AAAA,IACjB,SAAS;AAAA,IACT,cAAc;AAAA,EAAA;AAElB,CAAC;AAEM,MAAM,qBAAqB;AAAA,EAChC,oBAAoB,GAAG;AAAA,IACrB,UAAU;AAAA,IACV,QAAQ,CAAC,OAAoB,SAAwB;AACnD,aAAO,WAAW,QAAQ;AAAA,QACxB,QAAQ,IAAI,WAAW,MAAM,IAAI,YAAY,KAAK,MAAM,KAAK,EAAE,CAAC;AAAA,QAChE,OAAO;AAAA,QACP,WAAW;AAAA,MAAA,CACZ,EAAE,MAAM,KAAK,MAAM,KAAK,EAAE;AAAA,IAC7B;AAAA,EAAA,CACD;AAAA,EACD;AAAA,EACA,eAAe;AAAA,IACb,eAAe,uBAAuB;AAAA,MACpC,WAAW;AAAA,QACT,kBAAkB,CAAC,GAAe,SAAqB;;AAIrD,gBAAM,SAAS,KAAK,MAAM,UAAU;AACpC,cACE,CAAC,UACD,OAAO,WAAW,OAClB,YAAO,CAAC,MAAR,mBAAW,cAAW,YAAO,CAAC,MAAR,mBAAW;AAEjC;AAEF,gBAAM,SAAS,EAAE;AACjB,gBAAM,MAAM,KAAK,SAAS,MAAM;AAEhC,gBAAM,cAAc,KAAK,MAAM;AAAA,YAC7B;AAAA,UAAA;AAEF,sBAAa,QAAQ,KAAK,KAAK,CAAC,MAAc,OAAe;AAC3D,uBAAW,MAAM;AACf,mBAAK,SAAS;AAAA,gBACZ,WAAW,gBAAgB,OAAO,IAAI,IAAI;AAAA,cAAA,CAC3C;AAAA,YACH,GAAG,CAAC;AACJ,mBAAO;AAAA,UACT,CAAC;AAAA,QACH;AAAA,MAAA;AAAA,IACF,CACD;AAAA,EAAA,CACF;AACH;"}